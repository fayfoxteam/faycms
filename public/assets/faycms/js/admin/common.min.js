var common={filebrowserImageUploadUrl:null,filebrowserFlashUploadUrl:null,dragsortKey:null,validformParams:{forms:{},settings:{poshytip:{init:function(){system.getCss(system.assets("css/tip-twitter/tip-twitter.css"));system.getScript(system.assets("js/jquery.poshytip.min.js"))},showAllErrors:true,onAjaxEnd:function(a,b){if(!b.status){$("body").unblock()}},beforeCheck:function(){$("body").block({zindex:1300})},onError:function(c,d,b){$("body").unblock();var a=$.validform.getElementsByName(c).last();a.poshytip("destroy");a.poshytip({className:"tip-twitter",showOn:"none",alignTo:"target",alignX:"inner-right",offsetX:-60,offsetY:5,content:d}).poshytip("show")},onSuccess:function(b){var a=$.validform.getElementsByName(b).last();a.poshytip("destroy")}},setting:{settingForm:$("#setting-form-submit"),init:function(){system.getCss(system.assets("css/tip-twitter/tip-twitter.css"));system.getScript(system.assets("js/jquery.poshytip.min.js"))},ajaxSubmit:true,beforeSubmit:function(){this.settingForm.nextAll("span").remove();this.settingForm.after('<img src="'+system.assets("images/throbber.gif")+'" class="submit-loading" />')},afterAjaxSubmit:function(a){if(a.status){this.settingForm.nextAll("img,span,a").remove();this.settingForm.after('<span class="fc-green" style="margin-left:6px;">保存成功，刷新页面后生效。</span><a href="javascript:window.location.reload();">点此刷新</a>')}else{common.alert(a.message)}},onError:function(c,d,b){var a=$.validform.getElementsByName(c).last();a.poshytip("destroy");a.poshytip({className:"tip-twitter",showOn:"none",alignTo:"target",alignX:"inner-right",offsetX:-60,offsetY:5,content:d}).poshytip("show")},onSuccess:function(b){var a=$.validform.getElementsByName(b).last();a.poshytip("destroy")}}}},settingValidform:null,fancybox:function(){if($(".fancybox-image").length){system.getCss(system.assets("css/jquery.fancybox-1.3.4.css"),function(){system.getScript(system.assets("js/jquery.fancybox-1.3.4.pack.js"),function(){$(".fancybox-image").fancybox({transitionIn:"elastic",transitionOut:"elastic",type:"image",padding:0,centerOnScroll:true})})})}if($(".fancybox-inline").length){system.getCss(system.assets("css/jquery.fancybox-1.3.4.css"),function(){system.getScript(system.assets("js/jquery.fancybox-1.3.4.pack.js"),function(){$(".fancybox-inline").fancybox({padding:0,centerOnScroll:true,onClosed:function(a){$($(a).attr("href")).find("input,select,textarea").each(function(){$(this).poshytip("hide")})},type:"inline"})})})}if($(".fancybox-iframe").length){system.getCss(system.assets("css/jquery.fancybox-1.3.4.css"),function(){system.getScript(system.assets("js/jquery.fancybox-1.3.4.pack.js"),function(){$(".fancybox-iframe").fancybox({centerOnScroll:true,type:"iframe",width:750,autoDimensions:true})})})}if($(".fancybox-close").length){system.getCss(system.assets("css/jquery.fancybox-1.3.4.css"),function(){system.getScript(system.assets("js/jquery.fancybox-1.3.4.pack.js"),function(){$(document).on("click",".fancybox-close",function(){$.fancybox.close()})})})}},notification:function(){$(document).on("click",".header-notification-mute",function(){$.ajax({type:"GET",url:system.url("admin/notification/mute"),dataType:"json",cache:false,success:function(a){common.headerNotification()}})});$("#faycms-messages-container").on("click",".last a",function(){window.location.href=$(this).attr("href");return false});$("#faycms-message").on("click",".delete-message-link",function(){var a=$(this);$.ajax({type:"GET",url:system.url("admin/notification/delete",{id:a.attr("data-id")}),dataType:"json",cache:false,success:function(b){if(b.status==1){a.parent().css("background-color","red").fadeOut("slow",function(){$(this).remove()})}else{common.alert(b.message)}common.headerNotification()}});return false}).on("click","#faycms-messages-container",function(){return false}).on("click",".set-read-link",function(){var a=$(this);$.ajax({type:"GET",url:system.url("admin/notification/set-read"),data:{id:a.attr("data-id"),read:1},dataType:"json",cache:false,success:function(b){if(b.status==1){a.parent().css("background-color","orange").fadeOut("slow",function(){$(this).remove()})}else{common.alert(b.message)}common.headerNotification()}});return false})},headerNotification:function(){$.ajax({type:"GET",url:system.url("admin/notification/get"),dataType:"json",cache:false,success:function(b){$("#faycms-messages .faycms-message-item").remove();if(b.data.length){$("#faycms-message .badge").text(b.data.length).show();var a=false;$.each(b.data,function(c,d){if(new Date().getTime()-d.publish_time*1000<50000){a=true}$("#faycms-messages").append(['<li class="faycms-message-item"><span class="faycms-message-container">','<span class="block">','<span class="fc-grey small">',system.shortDate(d.publish_time),"</span>","</span>",'<span class="ellipsis" title="',d.title,'">',d.title,"</span>",'<a href="javascript:;" class="set-read-link fa fa-bell-slash" data-id="',d.notification_id,'" title="标记为已读"></a>','<a href="javascript:;" class="delete-message-link" data-id="',d.notification_id,'" title="删除">×</a>',"</span></li>"].join(""))});system.getScript(system.assets("js/jquery.slimscroll.min.js"),function(){$("#faycms-messages").slimScroll({height:"300px",color:"#a1b2bd",opacity:0.3})});if(a){$("#faycms-message").addClass("open")}}else{$("#faycms-messages").prepend(['<li class="faycms-message-item"><span class="faycms-message-container">','<span class="ellipsis" title="">暂无未读信息</span>',"</span></li>"].join(""));$("#faycms-message .badge").text(0).hide()}}})},menu:function(){$("#main-menu").on("click",".has-sub > a",function(){if($(this).parent().parent().parent().hasClass("has-sub")||!$("#sidebar-menu").hasClass("collapsed")||$(window).width()<768||($.browser.msie&&$.browser.version=="8.0")){var a=300,d=$(this).parent(),b=$(this).next("ul"),c=b.children("li");if(d.hasClass("expanded")){b.slideUp(a,function(){d.removeClass("expanded").removeClass("opened");$(this).removeAttr("style")})}else{b.slideDown(a,function(){$(this).removeAttr("style")});d.addClass("expanded");c.addClass("is-hidden");setTimeout((function(e){return function(){e.addClass("is-shown")}})(c),0);setTimeout((function(e){return function(){e.removeClass("is-hidden is-shown")}})(c),500);d.siblings(".expanded").children("ul").slideUp(a,function(){d.siblings(".expanded").removeClass("expanded").removeClass("opened");$(this).removeAttr("style")})}return false}});$(".toggle-mobile-menu").on("click",function(){$("#main-menu").toggleClass("mobile-is-visible")});$(".toggle-sidebar").on("click",function(){$("#sidebar-menu").toggleClass("collapsed");$(window).resize();$.ajax({type:"POST",url:system.url("admin/system/setting"),data:{_key:"admin_sidebar_class","class":$("#sidebar-menu").hasClass("collapsed")?"collapsed":""}})});if($(".sidebar-menu").hasClass("fixed")&&!($.browser.msie&&$.browser.version<9)){system.getCss(system.assets("css/perfect-scrollbar.css"),function(){system.getScript(system.assets("js/perfect-scrollbar.js"),function(){if(parseInt($(window).width())>768&&!$(".sidebar-menu").hasClass("collapsed")){$(".sidebar-menu-inner").perfectScrollbar({wheelPropagation:true})}$(window).resize(function(){if(parseInt($(window).width())>768&&!$(".sidebar-menu").hasClass("collapsed")){$(".sidebar-menu-inner").perfectScrollbar({wheelPropagation:true})}else{$(".sidebar-menu-inner").perfectScrollbar("destroy")}})})})}else{$(".sidebar-menu").removeClass("fixed")}},screenMeta:function(){if($(".screen-meta-links a").length){system.getCss(system.assets("css/jquery.fancybox-1.3.4.css"),function(){system.getScript(system.assets("js/jquery.fancybox-1.3.4.pack.js"),function(){$(".screen-meta-links > a").fancybox({padding:0,centerOnScroll:true,titleShow:false,onClosed:function(a){$($(a).attr("href")).find("input,select,textarea").each(function(){$(this).poshytip("hide")})}})})});$(".faycms-setting-link").on("mouseover",function(){$(this).addClass("fa-spin")}).on("mouseleave",function(){$(this).removeClass("fa-spin")})}},dragsort:function(){if($(".dragsort").length){system.getScript(system.assets("js/jquery.dragsort-0.5.1.js"),function(){$(".dragsort").dragsort({itemSelector:"div.box",dragSelector:"h4",dragBetween:true,placeHolderTemplate:'<div class="box holder"></div>',dragSelectorExclude:"input,textarea,select,table,span,p",dragEnd:function(){$(".dragsort").find("input,select,textarea").each(function(){if($(this).data("poshytip")){$(this).poshytip("refresh")}});if(common.dragsortKey){var a={_key:common.dragsortKey};$(".dragsort").each(function(){var b=[];$(this).find(".box").each(function(){if($(this).attr("data-name")){b.push($(this).attr("data-name"))}});a[$(this).attr("id")]=b});$.ajax({type:"POST",url:system.url("admin/system/setting"),data:a,dataType:"json",cache:false,success:function(b){if(b.status){}else{common.alert(b.message)}}})}}})})}},poshytip:function(){if($(".poshytip").length){system.getCss(system.assets("css/tip-twitter/tip-twitter.css"));system.getScript(system.assets("js/jquery.poshytip.min.js"),function(){$(".poshytip").poshytip({className:"tip-twitter",alignTo:"target",alignX:"center",showTimeout:5})})}},fixContent:function(){if($(".fixed-content").length){system.getScript(system.assets("faycms/js/fayfox.fixcontent.js"),function(){$(".fixed-content").fixcontent()})}},events:function(){$(document).on("mouseenter",".box-title, .toggle-hover, .list-table tr",function(){$(this).addClass("hover")}).on("mouseleave",".box-title, .toggle-hover, .list-table tr",function(){$(this).removeClass("hover")});$(document).on("click",".box-title .toggle",function(){$(this).parent().parent().toggleClass("closed")});$(document).on("click",".box-title .remove",function(){var b=$(this).parent().parent();b.slideUp("normal",function(){$(this).remove()});var a=$("#setting-form input[name='boxes[]'][value='"+b.attr("data-name")+"']");if(a.length){a.attr("checked",false);$("#setting-form").submit()}});$(document).on("click",'a[id$="submit"]',function(){var a=$("form#"+$(this).attr("id").replace("-submit",""));a.find('input[name="_export"]').remove();a.append('<input type="hidden" name="_submit" value="'+$(this).attr("id")+'">');a.submit();return false});$(document).on("click",'a[id$="export"]',function(){$("form#"+$(this).attr("id").replace("-export","")).append('<input type="hidden" name="_export" value="1" />').submit();return false});$('a[id$="reset"]').click(function(){$("form#"+$(this).attr("id").replace("-reset",""))[0].reset()});$(".list-table").each(function(){$(this).find("tr:even").addClass("alternate")});$(document).on("click",".remove-link",function(){return confirm("确实要永久删除此记录吗？")})},pager:function(){$(".pager .pager-input").each(function(){var a=parseInt($(this).val().length);if(a>1){$(this).css({width:50+7*(a-1)})}});$(document).on("keyup",".pager .pager-input",function(c){if(c.keyCode==13||c.keyCode==108){var b=window.location.href;if(b.indexOf("?")>0){window.location.href=b+"&"+$(this).attr("name")+"="+$(this).val()}else{window.location.href=b+"?"+$(this).attr("name")+"="+$(this).val()}}else{if($(this).val()>$(this).attr("max")){$(this).val($(this).attr("max"))}var a=parseInt($(this).val().length);if(a){$(this).css({width:50+7*(a-1)})}else{$(this).css({width:50}).val("")}}})},validform:function(){if($("form.validform").length){system.getScript(system.assets("faycms/js/fayfox.validform.min.js"),function(){if(!$.isEmptyObject(common.validformParams.forms)){for(var a in common.validformParams.forms){common.validformParams.settings[common.validformParams.forms[a].model].init();common.validformParams.forms[a].obj=$("form#"+(common.validformParams.forms[a].scene=="default"?"form":common.validformParams.forms[a].scene+"-form")).validform(common.validformParams.settings[common.validformParams.forms[a].model],common.validformParams.forms[a].rules,common.validformParams.forms[a].labels)}}var b=common.validformParams.settings.poshytip;b.init();$("form.validform").validform(b)})}},datepicker:function(){if($(".timepicker").length){system.getScript(system.assets("js/My97DatePicker/WdatePicker.js"),function(){$(document).on("focus",".timepicker",function(){WdatePicker({dateFmt:"yyyy-MM-dd HH:mm:ss"})})})}if($("input.datetimepicker").length){system.getCss(system.assets("js/datetimepicker/jquery.datetimepicker.css"));system.getScript(system.assets("js/datetimepicker/jquery.datetimepicker.js"),function(){$("input.datetimepicker").datetimepicker({lang:"ch",format:"Y-m-d H:i:00",formatDate:"Y-m-d",formatTime:"H:i",dayOfWeekStart:1,yearStart:2010,yearEnd:2037,allowBlank:($.browser.msie&&$.browser.version<9)?false:true,onShow:function(c,f){setTimeout((function(e){return function(){var g=parseInt($(e).css("top"));if(g){$(e).css("top",g+2)}}})(this),20);this.setOptions({maxDate:false,maxTime:false,minDate:false,minTime:false});var a=$(f).attr("name");if(a){if(a.indexOf("start_time")===0){var b=$(f).parent().find('input.datetimepicker[name^="end_time"]').val();if(b){this.setOptions({maxDate:b.split(" ")[0]})}}else{if(a.indexOf("end_time")===0){var d=$(f).parent().find('input.datetimepicker[name^="start_time"]').val();if(d){this.setOptions({minDate:d.split(" ")[0]})}}}}}})})}},visualEditor:function(){if($("#visual-editor").length){window.CKEDITOR_BASEPATH=system.assets("js/ckeditor/");system.getScript(system.assets("js/ckeditor/ckeditor.js"),function(){CKEDITOR.on("dialogDefinition",function(b){var c=b.data.name;var e=b.data.definition;if(c=="table"){var d=e.getContents("info");d.get("txtWidth")["default"]="";d.get("txtBorder")["default"]="";d.get("txtCellSpace")["default"]="";d.get("txtCellPad")["default"]="";d.get("txtCols")["default"]="3";d.get("selHeaders")["default"]="row"}});var a={height:$("#visual-editor").height()};if(common.filebrowserImageUploadUrl){a.filebrowserImageUploadUrl=common.filebrowserImageUploadUrl}if(common.filebrowserFlashUploadUrl){a.filebrowserFlashUploadUrl=common.filebrowserFlashUploadUrl}if($("#visual-editor").hasClass("visual-simple")||parseInt($(window).width())<743){a.toolbar=[["Source"],["TextColor","BGColor"],["Bold","Italic","Underline","Strike","Subscript","Superscript","-","RemoveFormat"],["Image","Table"]];a.enterMode=CKEDITOR.ENTER_BR;a.shiftEnterMode=CKEDITOR.ENTER_P}common.editorObj=CKEDITOR.replace("visual-editor",a)})}},markdownEditor:function(){if($("#wmd-input").length){system.getCss(system.assets("js/editor.md/css/editormd.min.css"));system.getScript(system.assets("js/editor.md/editormd.min.js"),function(){common.editorObj=editormd("markdown-container",{height:350,syncScrolling:"single",path:system.assets("js/editor.md/lib/"),toolbarIcons:function(){return["undo","redo","|","bold","del","italic","quote","|","h1","h2","h3","|","list-ul","list-ol","|","link","image","code","table","|","watch","preview","search","help"]},imageUpload:common.filebrowserImageUploadUrl?true:false,imageFormats:["jpg","jpeg","gif","png","webp"],imageUploadURL:common.filebrowserImageUploadUrl,saveHTMLToTextarea:true})})}},removeEditor:function(){common.editorObj.destroy()},tab:function(){$(document).on("click",".tabbable .nav-tabs a",function(){if(!$(this).parent().hasClass("active")){$($(this).parent().siblings(".active").find("a").attr("href")).find("input,select,textarea").each(function(){$(this).poshytip("hide")})}$($(this).attr("href")).show().siblings().hide();$(this).parent().addClass("active").siblings().removeClass("active");return false});var a=window.location.hash;$(".tabbable").each(function(){if($(this).find('.nav-tabs a[href="'+a+'"]').length){$(this).find('.nav-tabs a[href="'+a+'"]').click()}else{if($(this).find(".nav-tabs li.active").length){$(this).find(".nav-tabs li.active a").click()}else{$(this).find(".nav-tabs li:first a").click()}}})},showPager:function(c,a){var b=['<span class="summary">',a.total_records,"条记录</span>"];if(a.total_pages>1){if(a.current_page==1){b.push('<a href="javascript:;" title="首页" class="page-numbers first disabled">&laquo;</a>');b.push('<a href="javascript:;" title="上一页" class="page-numbers prev disabled">&lsaquo;</a>')}else{b.push('<a href="javascript:;" title="首页" class="page-numbers first" data-page="1">&laquo;</a>');b.push('<a href="javascript:;" title="上一页" class="page-numbers prev" data-page="'+(a.current_page-1)+'">&lsaquo;</a>')}b.push(' 第 <input type="number" value="'+a.current_page+'" class="form-control pager-input" min="1" max="'+a.total_pages+'" /> 页，共'+a.total_pages+"页");if(a.current_page==a.total_pages){b.push('<a href="javascript:;" title="下一页" class="page-numbers prev disabled">&rsaquo;</a>');b.push('<a href="javascript:;" title="末页" class="page-numbers first disabled">&raquo;</a>')}else{b.push('<a href="javascript:;" title="下一页" class="page-numbers prev" data-page="'+(a.current_page+1)+'">&rsaquo;</a>');b.push('<a href="javascript:;" title="末页" class="page-numbers first" data-page="'+a.total_pages+'">&raquo;</a>')}}$("#"+c).html(b.join(""))},batch:function(){$("body").on("change",".batch-ids-all",function(){$('.batch-ids[disabled!="disabled"],.batch-ids-all').attr("checked",!!$(this).attr("checked"))}).on("click","#batch-form-submit",function(){if($("#batch-action").val()==""){common.alert("请选择操作")}else{$('#batch-form [name="batch_action"],#batch-form [name="_submit"]').remove();$("#batch-form").append('<input type="hidden" name="batch_action" value="'+$("#batch-action").val()+'">').append('<input type="hidden" name="_submit" value="batch-form-submit">');$("body").block();$("#batch-form").submit()}return false}).on("click","#batch-form-submit-2",function(){if($("#batch-action-2").val()==""){common.alert("请选择操作")}else{$('#batch-form [name="batch_action"],#batch-form [name="_submit"]').remove();$("#batch-form").append('<input type="hidden" name="batch_action" value="'+$("#batch-action-2").val()+'">').append('<input type="hidden" name="_submit" value="batch-form-submit-2">');$("body").block();$("#batch-form").submit()}return false})},dragsortList:function(){var a=$(".dragsort-list");if(a.length){system.getScript(system.assets("js/jquery.dragsort-0.5.1.js"),function(){a.dragsort({itemSelector:"div.dragsort-item",dragSelector:".dragsort-item-selector",placeHolderTemplate:'<div class="dragsort-item holder"></div>',dragEnd:function(e,d,f){a.find("input,select,textarea").each(function(){if($(this).data("poshytip")){$(this).poshytip("refresh")}})}})});a.on("click",".dragsort-rm",function(){$(this).parent().fadeOut("fast",function(){var b=$(this).parent();$(this).find("input,select,textarea").poshytip("destroy");$(this).remove();b.find("input,select,textarea").each(function(){if($(this).data("poshytip")){$(this).poshytip("refresh")}})})})}},textAutosize:function(){if($("textarea.autosize").length){system.getScript(system.assets("js/autosize.min.js"),function(){autosize($("textarea.autosize"))})}},dropdown:function(){$(document).on("click","a.dropdown",function(){if($(this).parent().hasClass("open")){$(this).parent().removeClass("open")}else{$(".dropdown-container").each(function(){if($(this).hasClass("open")){$(this).removeClass("open")}});$(this).parent().addClass("open")}return false});$(document).on("click",function(){$(".dropdown-container").each(function(){if($(this).hasClass("open")){$(this).removeClass("open")}})})},prettyPrint:function(){if($(".prettyprint").length){system.getScript(system.assets("js/prettify.js"),function(){prettyPrint()})}},notify:function(b,a){a=a||"success";system.getScript(system.assets("faycms/js/fayfox.toast.js"),function(){b="<p>"+b+"</p>";if(a=="success"){$.toast(b,a,{timeOut:5000,closeButton:false,click:"fadeOut",positionClass:"toast-top-right"})}else{if(a=="error"){$.toast(b,a,{timeOut:0,positionClass:"toast-top-right"})}else{if(a=="alert"){$.toast(b,a,{closeButton:false,positionClass:"toast-bottom-middle",click:"fadeOut"})}else{$.toast(b,a,{timeOut:0,positionClass:"toast-bottom-right"})}}}})},alert:function(a){this.notify(a,"alert")},init:function(){this.fancybox();this.menu();this.screenMeta();this.dragsort();this.poshytip();this.datepicker();this.batch();this.events();this.fixContent();this.validform();this.visualEditor();this.markdownEditor();this.tab();this.dragsortList();this.textAutosize();this.dropdown();this.notification();this.prettyPrint();this.pager()}};